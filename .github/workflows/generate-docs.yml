name: Generate Ontology Documentation

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'ontology/**/*.owl'
      - 'ontology/**/*.ttl'
      - 'ontology/**/*.rdf'

  workflow_dispatch:

jobs:
  generate-documentation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Download WIDOCO
        run: |
          wget https://github.com/dgarijo/Widoco/releases/download/v1.4.25/widoco-1.4.25-jar-with-dependencies_JDK-17.jar -O widoco.jar
      
      - name: Generate documentation
        run: |
          # Find all ontology files recursively in the ontology folder
          # Expected structure: ontology/module/version/*.{owl,ttl,rdf}
          find ontology -type f \( -name "*.owl" -o -name "*.ttl" -o -name "*.rdf" \) | while read ontology_file; do
            echo "Processing $ontology_file"
            
            # Extract the relative path from ontology/
            # Example: ontology/core/0.1/myonto.owl -> core/0.1/myonto.owl
            relative_path="${ontology_file#ontology/}"
            
            # Get the directory path without the filename
            # Example: core/0.1/myonto.owl -> core/0.1
            dir_path=$(dirname "$relative_path")
            
            # Get the filename without extension for logging
            # Example: myonto.owl -> myonto
            file_name=$(basename "$ontology_file")
            base_name="${file_name%.*}"
            
            # Create output directory maintaining the module/version structure
            # Documentation goes directly in docs/module/version/ folder
            # Example: docs/core/0.1/
            output_dir="docs/$dir_path"
            mkdir -p "$output_dir"
            
            echo "  Module/Version path: $dir_path"
            echo "  Ontology name: $base_name"
            echo "  Output directory: $output_dir"
            
            # Generate documentation
            java -jar widoco.jar \
              -ontFile "$ontology_file" \
              -outFolder "$output_dir" \
              -rewriteAll \
              #-includeImportedOntologies \
              -webVowl \
              -licensius 
            
            echo "Documentation generated for $ontology_file in $output_dir"
            
            # Rename index-en.html to index.html if it exists
            if [ -f "$output_dir/index-en.html" ]; then
              mv "$output_dir/index-en.html" "$output_dir/index.html"
              echo "Renamed index-en.html to index.html"
            fi
            
            echo "---"
          done
      
      - name: Commit and push documentation
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-generate ontology documentation [skip ci]"
            git push
          fi
